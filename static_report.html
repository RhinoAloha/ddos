<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Report an Incident</title>
  <!-- Bootstrap CSS (using CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Select2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <!-- Flag Icon CSS (optional) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/6.6.6/css/flag-icons.min.css" rel="stylesheet">
  <!-- Custom CSS for styling -->
  <style>
    .form-control:focus, .form-select:focus, .btn:focus {
      box-shadow: none;
      border-color: #ced4da;
    }
    .offcanvas .nav-link {
      color: #212529;
    }
    .offcanvas .nav-link:hover {
      color: #0d6efd;
    }
    .card {
      border: none;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      background-color: #ffffff;
    }
    body {
      background-color: #f1f1f1;
    }
    /* Custom style for Select2 to integrate with Bootstrap */
    .select2-container--default .select2-selection--single {
      height: calc(2.5rem + 2px);
      padding: 0.375rem 0.75rem;
      border: 1px solid #ced4da;
      border-radius: 0.375rem;
    }
    /* Footer styling */
    footer {
      margin-top: 2rem;
      text-align: center;
      color: #666;
      font-size: 0.9rem;
    }
  </style>
  <link rel="stylesheet" href="static/style.css">
</head>
<body class="bg-light">
  <!-- Common Header with Offcanvas Menu -->
  <header class="mb-4">
    <nav class="navbar navbar-light bg-light">
      <div class="container-fluid">
        <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#commonMenu" aria-controls="commonMenu">
          <span class="navbar-toggler-icon"></span>
        </button>
        <a class="navbar-brand d-none d-lg-block" href="static_dashboard.html">Unit500</a>
      </div>
    </nav>
    <div class="offcanvas offcanvas-start" tabindex="-1" id="commonMenu" aria-labelledby="commonMenuLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="commonMenuLabel">Menu</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <ul class="nav flex-column">
          <li class="nav-item"><a class="nav-link" href="static_dashboard.html">Main</a></li>
          <li class="nav-item"><a class="nav-link active" href="static_report.html">Report An Attack</a></li>
          <li class="nav-item"><a class="nav-link" href="top.html">Top Players</a></li>
          <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
        </ul>
      </div>
    </div>
  </header>

  <!-- Page Title -->
  <div class="container mb-4">
    <h1 class="display-4 text-center">Report an Incident</h1>
    <p class="text-center text-muted">Please provide details about the security incident you'd like to report.</p>
  </div>

  <!-- Report Form Card -->
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="card p-4">
          <div class="card-body">
            
              
            
            <form id="reportForm">
              <!-- Report Type Selection -->
              <div class="mb-3">
                <label for="report_type" class="form-label">Report Type</label>
                <select id="report_type" name="report_type" required class="form-select">
                  <option value="">Select Report Type</option>
                  <option value="defacement">Defacement</option>
                  <option value="ransomware">Ransomware</option>
                  <option value="ddos">DDoS</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <!-- Dynamic Fields Container -->
              <div id="dynamicFields" class="mb-3"></div>
              <div class="d-grid">
                <button type="submit" class="btn btn-primary">Submit Report</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer with version and timestamp -->
  <footer>
    <span id="footerVersion">Version: 3.0.21</span>
    <span id="footerTimestamp"></span>
  </footer>

  <!-- jQuery (required for Select2) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Select2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  
  <!-- Custom Script for Dynamic Fields, Country Dropdown, and Form Submission -->
  <script>
    $(document).ready(function() {
      // Define the API URL for submitting reports.
      const apiUrl = "https://lri3fp9pe2.execute-api.us-east-1.amazonaws.com/prod/report";

      // Dynamically load country data from RestCountries API.
      function loadCountryData() {
        return fetch("https://restcountries.com/v3.1/all")
          .then(response => response.json())
          .then(data => {
            const countries = data.map(country => ({
              id: country.cca2.toLowerCase(),
              text: country.name.common
            }));
            countries.sort((a, b) => a.text.localeCompare(b.text));
            return countries;
          })
          .catch(error => {
            console.error("Error loading country data:", error);
            return [];
          });
      }
  
      // Initialize Select2 on elements with class 'country-select'
      function initCountrySelect(countryData) {
        $('.country-select').select2({
          data: countryData,
          placeholder: "Select a country",
          allowClear: true,
          templateResult: function(country) {
            if (!country.id) return country.text;
            return $('<span><img src="https://flagcdn.com/16x12/' + country.id + '.png" class="me-1" /> ' + country.text + '</span>');
          },
          templateSelection: function(country) {
            return country.text;
          }
        });
      }
  
      let countryDataGlobal = [];
      loadCountryData().then(data => {
        countryDataGlobal = data;
        initCountrySelect(countryDataGlobal);
      });
  
      // Get today's date in YYYY-MM-DD format
      function getToday() {
        const today = new Date();
        const yyyy = today.getFullYear();
        let mm = today.getMonth() + 1;
        let dd = today.getDate();
        if (mm < 10) mm = '0' + mm;
        if (dd < 10) dd = '0' + dd;
        return `${yyyy}-${mm}-${dd}`;
      }
      const todayDate = getToday();
  
      // Dynamic field HTML for each report type:
      function defacementFields() {
        return `
          <div class="mb-3">
            <label for="group_name" class="form-label">Group Name (optional)</label>
            <input type="text" id="group_name" name="group_name" class="form-control">
          </div>
          <div class="mb-3">
            <label for="actor_name" class="form-label">Hacker Name</label>
            <input type="text" id="actor_name" name="actor_name" required class="form-control">
          </div>
          <div class="mb-3">
            <label for="targeted_website" class="form-label">Targeted Website</label>
            <input type="url" id="targeted_website" name="targeted_website" required placeholder="https://example.org" class="form-control">
          </div>
          <div class="form-check mb-3">
            <input type="checkbox" id="mass_defacement_checkbox" name="mass_defacement" value="yes" class="form-check-input">
            <label for="mass_defacement_checkbox" class="form-check-label">Mass Defacement</label>
          </div>
          <div id="massDefacementFields" class="mb-3 d-none">
            ${[...Array(10)].map((_, i) => `
              <div class="mb-2">
                <label for="targeted_website_mass_${i+1}" class="form-label">Targeted Website #${i+1}</label>
                <input type="url" id="targeted_website_mass_${i+1}" name="targeted_website_mass_${i+1}" placeholder="https://example.org" class="form-control">
              </div>
            `).join('')}
          </div>
          <div class="mb-3">
            <label for="source_attacker_country" class="form-label">Source Attacker Country</label>
            <select id="source_attacker_country" name="source_attacker_country" required class="form-select country-select">
              <option></option>
            </select>
          </div>
          <div class="mb-3">
            <label for="attack_date" class="form-label">Attack Date</label>
            <input type="date" id="attack_date" name="attack_date" required value="${todayDate}" max="${todayDate}" class="form-control">
          </div>
          <div class="mb-3">
            <label for="reason" class="form-label">Reason</label>
            <select id="reason" name="reason" required class="form-select">
              <option value="fun" selected>Just For Fun</option>
              <option value="politics">Politics</option>
              <option value="bored">Bored</option>
              <option value="for_profit">For Profit</option>
            </select>
          </div>
        `;
      }
  
      function ransomwareFields() {
        return `
          <div class="mb-3">
            <label for="group_name" class="form-label">Group Name (optional)</label>
            <input type="text" id="group_name" name="group_name" class="form-control">
          </div>
          <div class="mb-3">
            <label for="actor_name" class="form-label">Notifier Name</label>
            <input type="text" id="actor_name" name="actor_name" required class="form-control">
          </div>
          <div class="mb-3">
            <label for="targeted_company" class="form-label">Targeted Company</label>
            <input type="text" id="targeted_company" name="targeted_company" required class="form-control">
          </div>
          <div class="mb-3">
            <label for="victim_website" class="form-label">Victim Website</label>
            <input type="url" id="victim_website" name="victim_website" required placeholder="https://example.org" class="form-control">
          </div>
          <div class="mb-3">
            <label for="ransom_image" class="form-label">Ransom Image Proof</label>
            <input type="url" id="ransom_image" name="ransom_image" required value="http://www.example.org/image.png" class="form-control">
          </div>
          <div class="mb-3">
            <label for="victim_country" class="form-label">Victim Country</label>
            <select id="victim_country" name="victim_country" required class="form-select country-select">
              <option></option>
            </select>
          </div>
          <div class="mb-3">
            <label for="attack_date" class="form-label">Attack Date</label>
            <input type="date" id="attack_date" name="attack_date" required value="${todayDate}" max="${todayDate}" class="form-control">
          </div>
          <div class="mb-3">
            <label for="attacker_country" class="form-label">Attacker Country (Attack Source)</label>
            <select id="attacker_country" name="attacker_country" required class="form-select country-select">
              <option></option>
            </select>
          </div>
          <div class="mb-3">
            <label for="reason" class="form-label">Reason</label>
            <select id="reason" name="reason" required class="form-select">
              <option value="for_profit" selected>For Profit</option>
              <option value="fun">Just For Fun</option>
              <option value="politics">Politics</option>
              <option value="bored">Bored</option>
            </select>
          </div>
        `;
      }
  
      function ddosFields() {
        return `
          <div class="mb-3">
            <label for="group_name" class="form-label">Group Name (optional)</label>
            <input type="text" id="group_name" name="group_name" class="form-control">
          </div>
          <div class="mb-3">
            <label for="actor_name" class="form-label">Hacker Name</label>
            <input type="text" id="actor_name" name="actor_name" required class="form-control">
          </div>
          <div class="mb-3">
            <label for="targeted_website" class="form-label">Targeted Website</label>
            <input type="url" id="targeted_website" name="targeted_website" required placeholder="https://example.org" class="form-control">
          </div>
          <div class="mb-3">
            <label for="targeted_org" class="form-label">Targeted Organization Name (optional)</label>
            <input type="text" id="targeted_org" name="targeted_org" class="form-control">
          </div>
          <div class="mb-3">
            <label for="attack_type" class="form-label">Attack Type</label>
            <select id="attack_type" name="attack_type" required class="form-select">
              <option value="DDoS" selected>DDoS</option>
              <option value="DoS">DoS</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="attacked_country" class="form-label">Attacked Country (optional)</label>
            <select id="attacked_country" name="attacked_country" class="form-select country-select">
              <option></option>
            </select>
          </div>
          <div class="mb-3">
            <label for="attacker_country_affiliation" class="form-label">Attacker Country Affiliation (optional, default Unknown)</label>
            <select id="attacker_country_affiliation" name="attacker_country_affiliation" class="form-select country-select">
              <option></option>
            </select>
          </div>
          <div class="mb-3">
            <label for="attack_date" class="form-label">Attack Date</label>
            <input type="date" id="attack_date" name="attack_date" required value="${todayDate}" max="${todayDate}" class="form-control">
          </div>
          <div class="mb-3">
            <label for="check_host" class="form-label">check-host.net (optional)</label>
            <input type="text" id="check_host" name="check_host" placeholder="Enter report number e.g. 23774618ka2c" class="form-control">
            <small class="form-text text-muted">This is the last part of the link, e.g. https://check-host.net/check-report/23774618ka2c</small>
          </div>
          <div class="mb-3">
            <label for="additional_image" class="form-label">Additional Image Link (optional)</label>
            <input type="url" id="additional_image" name="additional_image" placeholder="Provide a link to the image" class="form-control">
            <small class="form-text text-muted">Provide a URL to an additional screenshot or image.</small>
          </div>
        `;
      }
  
      function otherFields() {
        return `
          <div class="mb-3">
            <label for="group_name" class="form-label">Group Name (optional)</label>
            <input type="text" id="group_name" name="group_name" class="form-control">
          </div>
          <div class="mb-3">
            <label for="actor_name" class="form-label">Hacker Name</label>
            <input type="text" id="actor_name" name="actor_name" required class="form-control">
          </div>
          <div class="mb-3">
            <label for="targeted_website" class="form-label">Targeted Website</label>
            <input type="url" id="targeted_website" name="targeted_website" required placeholder="https://example.org" class="form-control">
          </div>
          <div class="mb-3">
            <label for="targeted_company" class="form-label">Targeted Company</label>
            <input type="text" id="targeted_company" name="targeted_company" required class="form-control">
          </div>
          <div class="mb-3">
            <label for="attack_type" class="form-label">Attack Type</label>
            <input type="text" id="attack_type" name="attack_type" required class="form-control">
          </div>
          <div class="mb-3">
            <label for="attacked_country" class="form-label">Attacked Country</label>
            <select id="attacked_country" name="attacked_country" class="form-select country-select">
              <option></option>
            </select>
          </div>
          <div class="mb-3">
            <label for="attacker_country_affiliation" class="form-label">Attacker Country Affiliation</label>
            <select id="attacker_country_affiliation" name="attacker_country_affiliation" class="form-select country-select">
              <option></option>
            </select>
          </div>
          <div class="mb-3">
            <label for="attack_date" class="form-label">Attack Date</label>
            <input type="date" id="attack_date" name="attack_date" required value="${todayDate}" max="${todayDate}" class="form-control">
          </div>
          <div class="mb-3">
            <label for="reason" class="form-label">Reason</label>
            <select id="reason" name="reason" required class="form-select">
              <option value="fun" selected>Just For Fun</option>
              <option value="politics">Politics</option>
              <option value="bored">Bored</option>
              <option value="for_profit">For Profit</option>
            </select>
          </div>
        `;
      }
  
      // Update dynamic fields when report type changes.
      function updateDynamicFields() {
        const type = $("#report_type").val();
        if (type === "defacement") {
          $("#dynamicFields").html(defacementFields());
        } else if (type === "ransomware") {
          $("#dynamicFields").html(ransomwareFields());
        } else if (type === "ddos") {
          $("#dynamicFields").html(ddosFields());
        } else if (type === "other") {
          $("#dynamicFields").html(otherFields());
        } else {
          $("#dynamicFields").html("");
        }
        // Reinitialize Select2 on all country-select elements.
        initCountrySelect(countryDataGlobal);
      }
      $("#report_type").on("change", updateDynamicFields);
  
      // Update footer with version and current timestamp.
      function updateFooter() {
        const now = new Date();
        $("#footerTimestamp").text(" | Updated: " + now.toLocaleString());
      }
      updateFooter();
  
      // Convert country fields before submitting.
      function convertCountryFields(data) {
        const countryKeys = ["source_attacker_country", "victim_country", "attacker_country", "attacker_country_affiliation", "attacked_country"];
        countryKeys.forEach(key => {
          if (data[key] === "") {
            data[key] = "unknown";
          }
        });
      }
  
      // Form submission handling.
      $("#reportForm").on("submit", async function(e) {
        e.preventDefault();
        const submitButton = $(this).find('button[type="submit"]');
        submitButton.prop("disabled", true);
        const originalText = submitButton.text();
        submitButton.text("Submitting...");
  
        const formData = new FormData(this);
        const data = {};
        formData.forEach((value, key) => { data[key] = value; });
        if (!data.group_name || data.group_name.trim() === "") {
          data.group_name = "indie";
        }
        if (data.targeted_website && !/^https?:\/\//i.test(data.targeted_website)) {
          data.targeted_website = "http://" + data.targeted_website;
        }
        convertCountryFields(data);
  
        console.log("Submitting report data:", data);
  
        try {
          if (data.mass_defacement) {
            let websites = [];
            if(data.targeted_website && data.targeted_website.trim() !== "") {
              websites.push(data.targeted_website);
            }
            for (let i = 1; i <= 10; i++) {
              let fieldName = 'targeted_website_mass_' + i;
              if (data[fieldName] && data[fieldName].trim() !== "") {
                websites.push(data[fieldName]);
              }
            }
            if (websites.length === 0) {
              alert("Please provide at least one Targeted Website.");
              submitButton.prop("disabled", false).text(originalText);
              return;
            }
            const requests = websites.map(site => {
              let newData = Object.assign({}, data);
              newData.targeted_website = site;
              newData.mass = true;
              delete newData.mass_defacement;
              for (let i = 1; i <= 10; i++) {
                delete newData['targeted_website_mass_' + i];
              }
              return fetch(apiUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(newData)
              });
            });
            const responses = await Promise.all(requests);
            let errors = [];
            for (let response of responses) {
              if (!response.ok) {
                const result = await response.json();
                errors.push(result.error);
              }
            }
            if (errors.length > 0) {
              alert("Error submitting report: " + errors.join(", "));
              submitButton.prop("disabled", false).text(originalText);
              return;
            } else {
              alert("Report submitted successfully for " + websites.length + " targeted website(s).");
              this.reset();
              $("#dynamicFields").html("");
            }
          } else {
            const response = await fetch(apiUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data)
            });
            const result = await response.json();
            if (response.ok) {
              alert("Report submitted successfully. Message ID: " + result.messageId);
              this.reset();
              $("#dynamicFields").html("");
            } else {
              alert("Error submitting report: " + result.error);
              submitButton.prop("disabled", false).text(originalText);
              return;
            }
          }
        } catch (err) {
          console.error("Error submitting report:", err);
          alert("Error submitting report: " + err.message);
          submitButton.prop("disabled", false).text(originalText);
          return;
        }
        submitButton.prop("disabled", false).text(originalText);
      });
    });
  </script>
</body>
</html>